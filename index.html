<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SICOP V17.33 - GMBH ULTIMATE (BLINDADO)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* DESIGN SYSTEM */
    :root {
      --primary: #3b82f6; --dark: #0f172a; --panel: #1e293b; --border: #334155; --text: #f8fafc;
      --accent: #0ea5e9; --danger: #ef4444; --warn: #f59e0b; --success: #10b981; --whatsapp: #25D366; --gold: #facc15;
      --status-off: #dc2626; --status-manu: #eab308; --status-on: #22c55e;
    }
    * { box-sizing: border-box; outline: none; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--dark); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* HEADER */
    header { height: 60px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    .logo { font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 10px; color: white; letter-spacing: 1px; }
    .logo span { color: var(--accent); }
    
    .weather-widget { display: flex; gap: 15px; font-size: 0.85rem; color: #94a3b8; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--border); }
    
    /* NAV TABS */
    .nav-tabs { display: flex; gap: 5px; background: #020617; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
    .tab-btn { background: transparent; color: #94a3b8; border: none; padding: 8px 12px; cursor: pointer; border-radius: 6px; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
    .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
    .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4); }
    .tab-status-alert { color: var(--status-manu) !important; }

    /* TOOLBAR (Header) */
    .toolbar-container { display: flex; gap: 10px; align-items: center; }
    .toolbar-group { display: flex; gap: 3px; background: rgba(255,255,255,0.03); padding: 3px 6px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }

    /* BOT√ïES GERAIS */
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; justify-content: center; transition: 0.2s; font-size: 0.9rem; color:white; }
    .btn-compact { padding: 6px 10px; font-size: 0.85rem; border-radius: 6px; }
    .btn-primary { background: var(--primary); }
    .btn-danger { background: var(--danger); }
    .btn-dark { background: #334155; border: 1px solid #475569; }
    .btn-whatsapp { background: var(--whatsapp); color: white; }
    .btn-csv { background: #15803d; color: white; border:none; }
    .btn-edit { background: #eab308; color: black !important; } 
    .mic-btn { background: transparent; color: var(--accent); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; padding: 0 10px; }
    .mic-btn.listening { color: var(--danger); animation: pulseRed 1.5s infinite; border-color: var(--danger); }
    
    @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

    /* TOAST */
    #toast { visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%); border-left: 5px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); font-size: 1rem; }
    #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    .main-container { flex: 1; display: flex; overflow: hidden; position: relative; }

    /* SIDEBAR */
    .sidebar { width: 380px; background: #0b1120; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 900; box-shadow: 5px 0 15px rgba(0,0,0,0.3); transition: width 0.3s ease; }
    
    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--border); }
    .kpi-item { padding: 10px; text-align: center; border: 1px solid #1e293b; background: #111827; }
    .kpi-item strong { display: block; font-size: 1.4rem; color: white; }
    .kpi-item small { color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; font-weight:bold; }
    
    .sidebar-tools { padding: 10px; background: var(--panel); border-bottom: 1px solid var(--border); }
    .search-wrapper { display: flex; gap: 5px; }
    .search-input { flex: 1; background: var(--dark); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; font-size: 0.9rem; }
    
    #feed { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }

    /* FEED CARD FIXED */
    .feed-card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.2s; cursor: pointer; display: flex; flex-direction: column; }
    .feed-card:hover { border-color: var(--accent); background: #2a3a55; }
    .feed-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); }
    .feed-info { display: flex; flex-direction: column; gap: 4px; width: 100%; }
    .cam-name { font-weight: bold; color: var(--text); font-size: 0.9rem; }
    .cam-meta { font-size: 0.75rem; color: #94a3b8; display: flex; justify-content: space-between; align-items: center; width: 100%; }
    
    /* Imagem no Feed */
    .feed-preview-img { width: 100%; height: 180px; object-fit: cover; border-bottom: 1px solid var(--border); display: none; background: #000; }
    
    .feed-details { display: none; border-top: 1px solid var(--border); background: #0f172a; max-height: 300px; overflow-y: auto; }
    .feed-card.expanded .feed-details { display: block; } 
    .action-row { display: flex; gap: 5px; padding: 10px; background: var(--panel); position:sticky; bottom:0; border-top:1px solid var(--border); }

    /* MAPA */
    .page { flex: 1; display: none; flex-direction: column; height: 100%; position: relative; }
    .page.active { display: flex; }
    #map { width: 100%; height: 100%; }
    
    .map-overlay { 
        position: absolute; top: 15px; left: 60px; right: 10px; 
        z-index: 800; display: flex; gap: 10px; flex-wrap: wrap; 
        pointer-events: none; align-items: flex-start;
    }
    .map-overlay > * { pointer-events: auto; }
    
    .glass-input { background: rgba(15, 23, 42, 0.95); border: 1px solid var(--border); color: white; padding: 8px 12px; border-radius: 30px; backdrop-filter: blur(8px); box-shadow: 0 4px 15px rgba(0,0,0,0.6); font-size: 0.85rem; }
    .glass-btn { background: rgba(15, 23, 42, 0.9); border: 1px solid var(--border); color: white; padding: 8px 14px; border-radius: 20px; cursor: pointer; transition: 0.2s; backdrop-filter: blur(5px); display: flex; gap: 5px; align-items: center; font-weight: 600; font-size: 0.85rem; }
    .glass-btn:hover { background: var(--primary); border-color: var(--primary); }
    .glass-btn.active { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }

    #mapSearch { width: 120px !important; transition: width 0.3s; }
    #mapSearch:focus { width: 180px !important; }
    #addrSearch { width: 150px !important; transition: width 0.3s; }
    #addrSearch:focus { width: 220px !important; }

    /* STATUS CARDS */
    .status-card { background: #1e293b; padding: 10px; border-radius: 6px; border: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .status-card.offline { border-left: 4px solid var(--status-off); }
    .status-card.manutencao { border-left: 4px solid var(--status-manu); }
    .status-card strong { color: #fff; font-size: 0.9rem; }
    .status-card small { color: #94a3b8; display: block; font-size: 0.75rem; }

    /* TABLES & LISTS */
    .table-container { overflow-x: auto; padding: 10px; }
    .full-table { width: 100%; border-collapse: collapse; min-width: 800px; background: var(--panel); }
    .full-table th { background: #020617; color: var(--accent); padding: 12px; text-align: left; position: sticky; top: 0; border-bottom: 1px solid var(--border); }
    .full-table td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }

    /* MODAL */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-box { background: var(--panel); width: 650px; max-width: 95%; padding: 0; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px black; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
    .modal-header { padding: 15px 25px; background: #020617; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 25px; overflow-y: auto; max-height: 70vh; display: flex; flex-direction: column; gap: 20px; }
    .modal-footer { padding: 20px 25px; background: #020617; border-top: 1px solid var(--border); display: flex; gap: 15px; }
    
    label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    select, input, textarea { width: 100%; padding: 12px 16px; background: #020617; border: 1px solid #334155; color: white; border-radius: 8px; transition: 0.2s; font-size: 0.95rem; }

    /* LOGIN & LOADING */
    #login { position: fixed; z-index: 9999; top:0; left:0; width:100%; height:100%; background: #020617; display:flex; justify-content:center; align-items:center; }
    .login-card { width: 360px; padding: 50px; background: var(--panel); border: 1px solid var(--border); border-radius: 16px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.6); }

    /* RESPONSIVIDADE (MOBILE FIX) */
    @media (max-width: 600px) {
        .sidebar { width: 100%; position: absolute; height: 100%; display: none; }
        .sidebar.mobile-open { display: flex; }
        #mobileMenuBtn { display: inline-block !important; }
        .logo, .weather-widget { display: none !important; }
        .nav-tabs { flex: 1; overflow-x: auto; }
        header { padding: 0 5px; gap: 5px; }
        .btn span { display: none; }
        .toolbar-container { display: none; } 
        
        .map-tools { width: 90%; top: 5px; gap: 4px; padding: 5px; }
        
        .mobile-sync-area { display: flex !important; gap: 10px; margin-top: 10px; padding: 0 15px; }
    }
    
    .mobile-sync-area { display: none; }
    
    /* Clusters e Marcadores */
    .marker-cluster-small { background-color: rgba(14, 165, 233, 0.5) !important; }
    .marker-cluster-small div { background-color: #0ea5e9; color: white; font-weight: 800; border: 2px solid white; }
    .marker-cluster-medium { background-color: rgba(30, 64, 175, 0.5) !important; }
    .marker-cluster-medium div { background-color: #1e40af; color: white; font-weight: 800; border: 2px solid white; }
    .marker-cluster-large { background-color: rgba(15, 23, 42, 0.6) !important; }
    .marker-cluster-large div { background-color: #0f172a; color: #3b82f6; font-weight: 900; border: 2px solid #3b82f6; }
    
    .custom-div-icon { background: transparent; border: none; }
    .marker-pin { width: 40px; height: 40px; border-radius: 50% 50% 50% 0; background: #3b82f6; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -20px 0 0 -20px; display: flex; justify-content: center; align-items: center; border: 2px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.5); }
    .marker-pin i { transform: rotate(45deg); color: white; font-size: 16px; }
    .pin-critico { background: #ef4444; box-shadow: 0 0 15px #ef4444; }
    .pin-alerta { background: #f59e0b; }
    .pin-obs { background: #10b981; }
    .pin-offline { background: var(--status-off) !important; box-shadow: 0 0 10px var(--status-off); }
    .pin-manutencao { background: var(--status-manu) !important; }

    /* EFEITO RADAR E GPS */
    .pulse-animation-icon { background: transparent; pointer-events: none; }
    .pulse-circle { width: 100%; height: 100%; border-radius: 50%; opacity: 0; animation: radarPulse 2s infinite ease-out; box-shadow: 0 0 10px currentColor; border: 2px solid currentColor; background: currentColor; }
    @keyframes radarPulse { 0% { transform: scale(0.1); opacity: 0.8; } 100% { transform: scale(2.5); opacity: 0; } }
    
    .gps-dot { width: 12px; height: 12px; background: #3b82f6; border: 2px solid white; border-radius: 50%; position: absolute; top: 4px; left: 4px; z-index: 2; }
    .gps-circle { width: 20px; height: 20px; background: rgba(59, 130, 246, 0.4); border-radius: 50%; position: absolute; top: 0; left: 0; animation: pulseGPS 2s infinite; }
    @keyframes pulseGPS { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

    .asset-marker { display: flex; justify-content: center; align-items: center; background: #1e293b; border: 2px solid white; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); color:white; font-size: 14px; }
    .asset-pm { border-color: #3b82f6; color: #3b82f6; }
    .asset-bm { border-color: #ef4444; color: #ef4444; }

    .dash-container { padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; height: 100%; }
    .chart-box { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; height: 350px; }
    .chart-wrapper { position: relative; width: 100%; height: 300px; }
    
    .plantao-container { padding: 20px; display: flex; flex-direction: column; height: 100%; }
    .log-input-area { display: flex; gap: 10px; margin-bottom: 20px; background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
    .log-list { flex: 1; overflow-y: auto; background: #000; border: 1px solid var(--border); border-radius: 8px; padding: 10px; font-family: monospace; }
    .log-item { border-left: 3px solid var(--accent); padding: 8px 12px; margin-bottom: 5px; background: rgba(255,255,255,0.03); }

    .password-wrapper { position: relative; width: 100%; }
    .toggle-pass { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8; }
    
    .credits-box { background: rgba(255,255,255,0.05); padding: 15px; border-left: 3px solid var(--primary); margin: 10px 0; text-align:left; }
  </style>
</head>
<body>

<div id="toast"></div>

<div id="login">
  <div id="loader" style="color:var(--accent); display:flex; flex-direction:column; align-items:center">
    <i class="fa-solid fa-radar fa-spin fa-2x" style="margin-bottom:20px"></i>
    <span>SICOP V17.33 - Carregando...</span>
  </div>
  <div id="loginForm" class="login-card" style="display:none">
    <h1 style="margin:0; color:white; font-size:2rem">SICOP <span style="color:var(--accent)">V17.33</span></h1>
    <p style="color:#64748b; margin-top:5px; font-size:0.9rem; letter-spacing:1px">GMBH ULTIMATE (BLINDADO)</p>
    
    <div style="margin-top:30px; text-align:left">
      <label>Matr√≠cula / Usu√°rio</label>
      <input id="u" placeholder="Ex: BM12345 ou ADMIN" style="margin-bottom:15px; text-transform:uppercase;" oninput="this.value = this.value.toUpperCase()">
      <label>Senha</label>
      <div style="position: relative; width: 100%;">
        <input id="p" type="password" placeholder="Sua senha" style="margin-bottom:25px; padding-right:40px">
        <i class="fa-solid fa-eye toggle-pass" onclick="togglePass()" style="position: absolute; right: 10px; top: 12px; cursor: pointer; color: #94a3b8;"></i>
      </div>
    </div>
    <button class="btn btn-primary" onclick="entrar()" style="width:100%">INICIAR SESS√ÉO</button>
    <div style="margin-top:20px; font-size:0.8rem; cursor:pointer; color:var(--danger); opacity:0.6" onclick="resetarSistema()">Resetar Sistema (Emerg√™ncia)</div>
  </div>
</div>

<div id="app" style="display:none; height:100%; flex-direction:column">
  
  <header>
    <div class="logo"><i class="fa-solid fa-crosshairs"></i> SICOP <span>V17.33</span></div>
    
    <div class="weather-widget" id="weatherWidget">
      <div style="display:flex;align-items:center;gap:5px"><i class="fa-solid fa-user-shield"></i> <span id="displayUser">--</span></div>
      <div style="display:flex;align-items:center;gap:5px; border-left:1px solid #555; padding-left:10px;"><i class="fa-solid fa-temperature-half" style="color:var(--warn)"></i> <span id="w-temp">--¬∞C</span></div>
    </div>

    <div class="nav-tabs">
      <button class="tab-btn active" onclick="mudarTab('mapa')"><i class="fa-solid fa-map"></i> Mapa</button>
      <button class="tab-btn" onclick="mudarTab('lista')"><i class="fa-solid fa-list"></i> Lista</button>
      <button class="tab-btn tab-status-alert" onclick="mudarTab('status')"><i class="fa-solid fa-triangle-exclamation"></i> Status</button>
      <button class="tab-btn" onclick="mudarTab('dash')"><i class="fa-solid fa-chart-pie"></i> B.I.</button>
      <button class="tab-btn" onclick="mudarTab('plantao')"><i class="fa-solid fa-book"></i> Plant√£o</button>
      <button class="tab-btn" onclick="toggleSidebarMobile()" style="display:none" id="mobileMenuBtn"><i class="fa-solid fa-bars"></i></button>
    </div>

    <div class="toolbar-container">
      <div class="toolbar-group" title="Nuvem (JSONBin)">
         <button class="btn btn-dark btn-compact" onclick="carregarDaNuvem()" title="Baixar da Nuvem" style="color:#0ea5e9; border-color:#0ea5e9"><i class="fa-solid fa-cloud-arrow-down"></i></button>
         <button class="btn btn-dark btn-compact" onclick="salvarNaNuvem()" title="Salvar na Nuvem" style="color:#10b981; border-color:#10b981"><i class="fa-solid fa-cloud-arrow-up"></i></button>
      </div>
      <div class="toolbar-group" title="Dados e Backup">
         <button class="btn btn-dark btn-compact" onclick="fazerBackup()" title="Backup Completo ZIP" style="color:var(--gold); border-color:var(--gold)"><i class="fa-solid fa-file-zipper"></i></button>
         <label class="btn btn-dark btn-compact" title="Restaurar Backup ZIP" style="cursor:pointer; color:var(--accent); border-color:var(--accent)">
           <i class="fa-solid fa-upload"></i> <input type="file" hidden accept=".zip" onchange="restaurarBackup(this)">
         </label>
      </div>
      <div class="toolbar-group" title="JSON e Excel">
         <button class="btn btn-dark btn-compact" onclick="exportarDadosTurno()" title="Baixar JSON"><i class="fa-solid fa-download"></i></button>
         <button class="btn btn-csv btn-compact" onclick="exportarCSV()" title="Baixar Excel (CSV)"><i class="fa-solid fa-table"></i></button>
         <label class="btn btn-dark btn-compact" style="cursor:pointer" title="Importar JSON"><i class="fa-solid fa-file-import"></i> <input type="file" hidden accept=".json" onchange="importarDadosTurno(this)"></label>
      </div>
      <div class="toolbar-group" title="Sistema">
         <button class="btn btn-dark btn-compact" onclick="abrirSobre()" title="Sobre"><i class="fa-solid fa-circle-info"></i></button>
         <button class="btn btn-dark btn-compact" id="btnAdmin" onclick="abrirModalUsers()" title="Gest√£o" style="display:none"><i class="fa-solid fa-users-gear"></i></button>
         <button class="btn btn-dark btn-compact" onclick="toggleFullScreen()" title="Tela Cheia"><i class="fa-solid fa-expand"></i></button>
      </div>
      <div class="toolbar-group" title="Relat√≥rios e Encerramento" style="border-color: rgba(239, 68, 68, 0.3);">
        <button class="btn btn-dark btn-compact" onclick="gerarRelatorioBI()" title="Gerar Dados para B.I." style="color:#0ea5e9; border-color:#0ea5e9">
            <i class="fa-solid fa-chart-column"></i> BI
        </button>
        <button class="btn btn-danger btn-compact" onclick="exportarRelatorioExecutivo()" title="PDF Geral" style="background:#dc2626; border:none"><i class="fa-solid fa-file-pdf"></i></button>
        <button class="btn btn-whatsapp btn-compact" onclick="encerrarPlantaoZap()" title="Encerrar Plant√£o"><i class="fa-brands fa-whatsapp"></i></button>
      </div>
    </div>
  </header>

  <div class="main-container">
    <div class="sidebar" id="sidebar">
      <div class="mobile-sync-area">
          <button class="btn btn-dark" onclick="carregarDaNuvem()" style="flex:1; border-color:#0ea5e9; color:#0ea5e9"><i class="fa-solid fa-cloud-arrow-down"></i> Baixar Nuvem</button>
          <button class="btn btn-dark" onclick="salvarNaNuvem()" style="flex:1; border-color:#10b981; color:#10b981"><i class="fa-solid fa-cloud-arrow-up"></i> Salvar Nuvem</button>
      </div>

      <div class="kpi-grid">
        <div class="kpi-item"><strong id="k_abertas" style="color:var(--warn)">0</strong><small>Pendentes</small></div>
        <div class="kpi-item"><strong id="k_hoje" style="color:var(--accent)">0</strong><small>Hoje</small></div>
      </div>
      
      <div class="sidebar-tools">
        <div class="search-wrapper">
            <input type="text" class="search-input" placeholder="Buscar c√¢mera..." onkeyup="buscarCamSidebar(this.value)">
            <button class="tool-btn" onclick="toggleFilter()" title="Filtrar por Data"><i class="fa-solid fa-filter"></i></button>
        </div>
        
        <div id="filterContainer">
            <label style="margin-bottom:5px">Filtrar por Data:</label>
            <div style="display:flex; gap:5px">
                <input type="date" id="filtroData" onchange="atualizarTudo()" style="padding:6px">
                <button onclick="limparFiltroData()" class="btn-dark" style="padding:0 10px"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
      </div>

      <div style="padding:5px 15px; color:#94a3b8; font-size:0.75rem; text-align:center">
        <i class="fa-solid fa-hand-pointer"></i> Clique na foto para ampliar
      </div>

      <div id="feed"></div>
    </div>

    <div id="tab-mapa" class="page active">
      <div class="map-overlay">
        <button class="glass-btn" onclick="localizarUsuario()" title="Minha Localiza√ß√£o"><i class="fa-solid fa-crosshairs"></i> GPS</button>
        <button class="glass-btn" id="btnHeat" onclick="toggleHeatmap()"><i class="fa-solid fa-fire"></i> Calor</button>
        <button class="glass-btn" id="btnRadius" onclick="toggleRadiusTool()" title="Zona"><i class="fa-solid fa-draw-polygon"></i> Zona</button>
        <button class="glass-btn" id="btnPin" onclick="togglePinMode()" title="Marcar Local Manualmente" style="border-color: var(--accent); color: var(--accent);">
            <i class="fa-solid fa-location-dot"></i> Ponto
        </button>
        <select id="filtroArea" class="glass-input" onchange="renderMap()" style="width:140px">
            <option value="TODOS">Todas √Åreas</option>
        </select>
        <input id="mapSearch" class="glass-input" placeholder="üîç C√¢mera..." onkeyup="buscarCam(this.value)">
        <input id="addrSearch" class="glass-input" placeholder="üìç Endere√ßo BH..." onchange="irParaEndereco(this.value)">
        
        <div class="resource-toolbar">
            <button class="glass-btn" onclick="addAsset('PM')" style="padding: 8px 12px; border-radius: 50%;" title="VP (Carro)"><i class="fa-solid fa-car-side"></i></button>
            <button class="glass-btn" onclick="addAsset('BM')" style="padding: 8px 12px; border-radius: 50%;" title="SAMU/BM"><i class="fa-solid fa-truck-medical"></i></button>
            <button class="glass-btn" onclick="document.getElementById('kmlInput').click()" style="padding: 8px 12px; border-radius: 50%;" title="Carregar KML"><i class="fa-solid fa-file-import"></i></button>
            <input type="file" id="kmlInput" hidden accept=".kml" onchange="processarKML(this)">
        </div>
      </div>
      <div id="map"></div>
    </div>

    <div id="tab-lista" class="page">
        <div class="table-container">
            <h2 style="margin:0 0 20px 0; color:var(--accent)">Registro Global de Ocorr√™ncias</h2>
            <table class="full-table">
                <thead><tr><th>ID</th><th>Data/Hora</th><th>Local (C√¢mera + Endere√ßo)</th><th>Motivo</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                <tbody id="tabelaListaGeral"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-status" class="page">
        <div class="dash-container" style="display:block">
            <h2 style="color:var(--status-manu)">
                <i class="fa-solid fa-triangle-exclamation"></i> Relat√≥rio de C√¢meras Inoperantes
            </h2>
            
            <button class="btn btn-danger" onclick="gerarRelatorioStatusPDF()" style="margin-bottom:15px; width:100%">
                <i class="fa-solid fa-file-pdf"></i> BAIXAR RELAT√ìRIO PARA MANUTEN√á√ÉO
            </button>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px">
                <div style="display:flex; justify-content:space-around; text-align:center">
                    <div><h1 style="margin:0; color:var(--status-off)" id="st_off">0</h1><small>OFFLINE</small></div>
                    <div><h1 style="margin:0; color:var(--status-manu)" id="st_manu">0</h1><small>MANUTEN√á√ÉO</small></div>
                </div>
            </div>
            <div id="listaStatus" style="max-width:800px; margin:0 auto"></div>
        </div>
    </div>

    <div id="tab-dash" class="page">
      <div class="dash-container">
        <div class="chart-box"><h3 style="margin-top:0"><i class="fa-solid fa-chart-pie"></i> Motivos</h3><div class="chart-wrapper"><canvas id="chartMotivo"></canvas></div></div>
        <div class="chart-box"><h3 style="margin-top:0"><i class="fa-solid fa-triangle-exclamation"></i> Gravidade</h3><div class="chart-wrapper"><canvas id="chartGravidade"></canvas></div></div>
        <div class="chart-box"><h3 style="margin-top:0"><i class="fa-solid fa-map-location-dot"></i> Por √Årea</h3><div class="chart-wrapper"><canvas id="chartArea"></canvas></div></div>
        <div class="chart-box"><h3 style="margin-top:0"><i class="fa-solid fa-chart-line"></i> Evolu√ß√£o</h3><div class="chart-wrapper"><canvas id="chartTempo"></canvas></div></div>
      </div>
    </div>

    <div id="tab-plantao" class="page">
      <div class="plantao-container">
        <h2 style="margin-top:0; color:var(--accent)"><i class="fa-solid fa-book-open"></i> Livro de Plant√£o (Logs)</h2>
        <div class="log-input-area">
          <input id="logInput" type="text" placeholder="Digite o registro..." style="flex:1">
          <button class="mic-btn" onclick="startDictation('logInput', this)"><i class="fa-solid fa-microphone"></i></button>
          <button class="btn btn-primary" onclick="adicionarLog()">Gravar</button>
        </div>
        <div id="logList" class="log-list"></div>
      </div>
    </div>

  </div>
</div>

<div id="modalImgFull" class="modal" onclick="this.style.display='none'"><img id="fullImageElement" src="" alt="Ampliado"></div>

<div id="modal" class="modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle"><i class="fa-solid fa-triangle-exclamation" style="color:var(--warn)"></i> Nova Ocorr√™ncia</div>
      <button onclick="fecharModal()" style="background:transparent; border:none; color:#fff; font-size:1.5rem; cursor:pointer">√ó</button>
    </div>
    <div class="modal-body">
      <div style="background:#0f172a; padding:10px; border-radius:6px; border:1px solid #334155; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
         <span style="font-size:0.85rem; color:#aaa; font-weight:bold">STATUS DA C√ÇMERA:</span>
         <select id="quickStatus" onchange="quickUpdateStatus()" style="width:200px; padding:6px; font-weight:bold; background:#1e293b; border-color:#334155">
             <option value="ONLINE">üü¢ ONLINE</option>
             <option value="OFFLINE">üî¥ OFFLINE</option>
             <option value="MANUTENCAO">üü° MANUTEN√á√ÉO</option>
         </select>
      </div>

      <div style="background:#020617; padding:15px; border-radius:8px; border-left:4px solid var(--accent); display:flex; align-items:center; gap:15px">
        <i class="fa-solid fa-video fa-2x" style="color:var(--accent)"></i>
        <div style="flex:1">
          <label style="color:var(--accent); margin-bottom:0">Local</label>
          <div style="display:flex; gap:5px; margin-bottom: 5px;">
             <select id="selCam" style="background:transparent; border:none; font-weight:bold; font-size:1.1rem; color:white; padding:0; flex:1" onchange="atualizarStatusEEndereco(this.value)"></select>
             <button onclick="verStreetView()" class="btn btn-dark btn-compact" title="Ver Street View"><i class="fa-solid fa-street-view"></i></button>
          </div>
          <input id="endAutomatico" placeholder="Endere√ßo (Edite se necess√°rio)" style="background: #0f172a; border: 1px solid #334155; color: white; font-size: 0.9rem; padding: 8px; border-radius: 6px; margin-top: 5px;">
        </div>
      </div>
      <div style="display:flex; gap:20px">
        <div style="flex:1">
          <label>Gravidade</label>
          <select id="selGrav"><option value="OBSERVACAO">üü¢ Observa√ß√£o</option><option value="ALERTA">üü° Alerta</option><option value="CRITICO">üî¥ CR√çTICO</option></select>
        </div>
        <div style="flex:1">
          <label>Motivo</label>
          <select id="selMot">
            <option value="ACIDENTE">üöó Acidente de Tr√¢nsito</option>
            <option value="OBSTRUCAO">üöß Obstru√ß√£o de Via</option>
            <option value="ESTACIONAMENTO">üö´ Estacionamento Irregular</option>
            <option value="SEMAFORO">üö¶ Sem√°foro com Defeito</option>
            <option value="BLITZ">üõë Blitz / Bloqueio</option>
            <option value="CRIME">üî´ Assalto / Roubo</option>
            <option value="FURTO">üß≤ Furto</option>
            <option value="TRAFICO">üíä Tr√°fico de Drogas</option>
            <option value="SUSPEITO">üë§ Indiv√≠duo Suspeito</option>
            <option value="VEICULO_SUSPEITO">üöì Ve√≠culo Suspeito/Clonado</option>
            <option value="VIOLENCIA_DOMESTICA">üè† Viol√™ncia Dom√©stica</option>
            <option value="BRIGA">üëä Rixa / Briga</option>
            <option value="VANDALISMO">üé® Vandalismo / Picha√ß√£o</option>
            <option value="DANO">üî® Dano ao Patrim√¥nio</option>
            <option value="PERTURBACAO">üîä Perturba√ß√£o do Sossego</option>
            <option value="AGLOMERACAO">üë• Aglomera√ß√£o</option>
            <option value="MANIFESTACAO">üì¢ Manifesta√ß√£o / Protesto</option>
            <option value="MORADOR_RUA">‚õ∫ Apoio Popula√ß√£o de Rua</option>
            <option value="ANIMAIS">üêï Animal Solto / Perigoso</option>
            <option value="INCENDIO">üî• Inc√™ndio</option>
            <option value="ALAGAMENTO">üåä Alagamento / Enchente</option>
            <option value="ARVORE">üå≥ Queda de √Årvore</option>
            <option value="APOIO_SAMU">üöë Apoio ao SAMU</option>
            <option value="EVENTO">üéâ Evento P√∫blico</option>
            <option value="POLICIAMENTO">üëÆ Policiamento Preventivo</option>
            <option value="OUTROS">‚ùì Outros</option>
          </select>
        </div>
      </div>
      <div>
        <label>Primeira A√ß√£o</label>
        <select id="selAcao">
            <option value="MONITORAMENTO">Apenas Monitoramento</option>
            <option value="GCM_ACIONADA">Guarda Civil Municipal (GCM)</option>
            <option value="PM_ACIONADA">Pol√≠cia Militar Acionada</option>
            <option value="BOMBEIROS_SAMU">Bombeiros / SAMU</option>
            <option value="TRANSITO">Agentes de Tr√¢nsito</option>
        </select>
      </div>
      <div>
        <label>Detalhes</label>
        <div style="display:flex; gap:10px"><textarea id="txtObs" placeholder="Descreva os detalhes..." style="flex:1"></textarea><button class="mic-btn" onclick="startDictation('txtObs', this)"><i class="fa-solid fa-microphone"></i></button></div>
      </div>
      <div>
        <label>Evid√™ncia (Foto)</label>
        <input type="file" id="fileImg" accept="image/*">
        <p id="editFileNote" style="display:none; color:var(--warn); font-size:0.8rem">Deixe vazio para manter a foto atual.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="fecharModal()" class="btn btn-dark" style="flex:1">Cancelar</button>
      <button onclick="salvarOcorrencia()" id="btnSave" class="btn btn-primary" style="flex:1">CONFIRMAR</button>
    </div>
  </div>
</div>

<div id="modalEncerrar" class="modal">
  <div class="modal-box" style="border-top: 5px solid var(--success)">
    <div class="modal-header" style="background:#064e3b"><div class="modal-title"><i class="fa-solid fa-check-circle"></i> Desfecho</div><button onclick="fecharModalEncerrar()" style="background:transparent; border:none; color:#fff; font-size:1.5rem; cursor:pointer">√ó</button></div>
    <div class="modal-body">
      <p style="color:#cbd5e1; font-size:0.95rem; margin:0">Informe o resultado final da opera√ß√£o.</p>
      <div><label>Tipo de Resolu√ß√£o</label><select id="resTipo"><option value="RESOLVIDO_LOCAL">Resolvido no Local</option><option value="ENCAMINHADO_DP">Encaminhado √† Delegacia</option><option value="ALARME_FALSO">Alarme Falso / Sem Altera√ß√£o</option><option value="EVADIU">Suspeito Evadiu-se</option><option value="LIBERADO">Liberado / Orientado</option></select></div>
      <div><label>Relat√≥rio Final</label><div style="display:flex; gap:10px"><textarea id="resObs" placeholder="Relat√≥rio de encerramento..." style="height:120px; flex:1"></textarea><button class="mic-btn" onclick="startDictation('resObs', this)"><i class="fa-solid fa-microphone"></i></button></div></div>
      <div style="margin-top:10px"><label>Evid√™ncia Final (Foto do Fechamento)</label><input type="file" id="fileImgFim" accept="image/*"></div>
      <input type="hidden" id="idEncerrar">
    </div>
    <div class="modal-footer">
      <button onclick="fecharModalEncerrar()" class="btn btn-dark" style="flex:1">Voltar</button>
      <button onclick="confirmarEncerramento()" class="btn btn-success" style="background:var(--success); flex:1">FINALIZAR</button>
    </div>
  </div>
</div>

<div id="modalUsers" class="modal">
  <div class="modal-box">
    <div class="modal-header"><div class="modal-title"><i class="fa-solid fa-users-gear"></i> Gest√£o de Usu√°rios</div><button onclick="fecharModalUsers()" style="background:transparent; border:none; color:#fff; font-size:1.5rem; cursor:pointer">√ó</button></div>
    <div class="modal-body">
        <div style="background:#020617; padding:15px; border-radius:8px; border:1px solid var(--border)">
            <h4 style="margin:0 0 10px 0; color:var(--primary)">Novo Usu√°rio</h4>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
                <input id="new_user" placeholder="Usu√°rio" style="flex:1">
                <input id="new_pass" type="password" placeholder="Senha" style="flex:1">
                <select id="new_role" style="flex:1"><option value="user">Operador</option><option value="admin">Administrador</option></select>
                <button class="btn btn-primary" onclick="criarUsuario()">Criar</button>
            </div>
        </div>
        <table class="user-table"><thead><tr><th>ID</th><th>Usu√°rio</th><th>Perfil</th><th>A√ß√£o</th></tr></thead><tbody id="userListBody"></tbody></table>
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border)">
            <h4 style="margin:0 0 10px 0; color:var(--warn)">Manuten√ß√£o do Sistema</h4>
            <button class="btn btn-dark" style="border-color:var(--warn); color:var(--warn)" onclick="limparAntigas()"><i class="fa-solid fa-broom"></i> Limpar Ocorr√™ncias Antigas</button>
        </div>
    </div>
  </div>
</div>

<div id="modalSobre" class="modal">
    <div class="modal-box" style="width:500px">
        <div class="modal-header">
            <div>Sobre o Sistema</div>
            <button onclick="document.getElementById('modalSobre').style.display='none'" style="background:transparent; border:none; color:white; font-size:1.5rem; cursor:pointer">√ó</button>
        </div>
        <div class="modal-body" style="text-align:center;">
             <i class="fa-solid fa-shield-halved fa-4x" style="color:var(--primary); margin-bottom:15px"></i>
             <h2 style="margin:0">SICOP V17.33</h2>
             <p style="color:#888; font-size:0.9rem">SISTEMA INTEGRADO DE OPERA√á√ïES</p>
             <div class="credits-box" style="background: rgba(255,255,255,0.05); padding: 15px; border-left: 3px solid var(--primary); margin: 10px 0; text-align:left;">
                <p><strong>üèõÔ∏è Institui√ß√£o:</strong> Guarda Municipal de Belo Horizonte</p>
                <p><strong>üìç Unidade:</strong> COP - Centro de Opera√ß√µes</p>
                <p><strong>üíª Desenvolvimento:</strong> GCD II Augusto Emiliano</p>
             </div>
             <p style="font-size:0.8rem; color:#555">¬© 2025 - GMBH. Todos os direitos reservados.</p>
        </div>
        <div class="modal-footer">
            <button onclick="document.getElementById('modalSobre').style.display='none'" class="btn btn-primary" style="width:100%">Fechar</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURA√á√ÉO JSONBIN E SEGURAN√áA ---
const BIN_ID = "6955e844d0ea881f404ce928"; 
// Chave protegida via Base64 para evitar leitura direta no c√≥digo fonte
const _k_part1 = "JDJhJDEwJGkvRi5YYU85eFRkbGYxTTRZZlJLaWVxcnBhRjVNYTBqWGh6Lkpyc2MxOVljYzN5VUNnODVT"; 
const API_KEY = atob(_k_part1);

// BLOQUEIO DE TECLAS DE DESENVOLVEDOR (F12, CTRL+SHIFT+I, etc)
document.addEventListener('keydown', function(e) {
    if (
        e.key === "F12" || 
        (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C")) || 
        (e.ctrlKey && e.key === "U")
    ) {
        e.preventDefault();
        return false;
    }
});
document.addEventListener('contextmenu', event => event.preventDefault());

function showToast(msg, type='success') {
    const t = document.getElementById('toast');
    t.innerText = msg; t.className = "show"; 
    t.style.borderLeftColor = type==='error'?'#ef4444':(type==='info'?'#3b82f6':'#10b981');
    setTimeout(()=>t.className="", 3000);
}

// ----------------------------------------------
// FUN√á√ïES DE NUVEM COM SEGURAN√áA
// ----------------------------------------------

async function carregarDaNuvem() {
    showToast("‚òÅÔ∏è Conectando...", "info");
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { "X-Master-Key": API_KEY }
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Erro na Nuvem:", errorText);
            alert(`ERRO NA NUVEM (${response.status}):\nVerifique se o BIN_ID e a API_KEY est√£o corretos no c√≥digo.`);
            return;
        }

        const res = await response.json();
        const dados = res.record;

        // --- 1. ATUALIZA USU√ÅRIOS ---
        if (dados.usuarios && dados.usuarios.length > 0) {
            db.run("DELETE FROM usuarios");
            db.run("BEGIN TRANSACTION");
            dados.usuarios.forEach(u => {
                db.run("INSERT INTO usuarios (id, user, pass, role, nome, orgao, status) VALUES (?, ?, ?, ?, ?, ?, ?)", 
                [u.id, u.user, u.pass, u.role, u.nome || '', u.orgao || '', u.status || 'ATIVO']);
            });
            db.run("COMMIT");
        }

        // --- 2. ATUALIZA OCORR√äNCIAS ---
        if (dados.ocorrencias) {
            if(confirm(`Dados baixados! Substituir as ${dados.ocorrencias.length} ocorr√™ncias locais?`)) {
                db.run("DELETE FROM ocorrencias");
                db.run("BEGIN TRANSACTION");
                dados.ocorrencias.forEach(o => {
                      db.run(`INSERT INTO ocorrencias (id, camera, area, gravidade, motivo, acao, obs, status, inicio, fim, img_id, lat, lng, endereco, resolucao) 
                              VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)`, 
                      [o.id, o.camera, o.area, o.gravidade, o.motivo, o.acao, o.obs, o.status, o.inicio, o.fim, o.img_id, o.lat, o.lng, o.endereco, o.resolucao]);
                });
                db.run("COMMIT");
            }
        }

        // --- 3. NOVO: ATUALIZA STATUS DAS C√ÇMERAS (INCLU√çDO AQUI) ---
        if (dados.cameras && Array.isArray(dados.cameras)) {
            try {
                // Tenta limpar a tabela existente
                db.run("DELETE FROM cameras");
            } catch(e) {
                // Se a tabela n√£o existir no banco do celular, cria ela agora
                db.run(`CREATE TABLE IF NOT EXISTS cameras (id INTEGER PRIMARY KEY, nome TEXT, status TEXT, lat REAL, lng REAL);`);
            }

            db.run("BEGIN TRANSACTION");
            dados.cameras.forEach(c => {
                db.run("INSERT INTO cameras (id, nome, status, lat, lng) VALUES (?, ?, ?, ?, ?)", 
                [c.id, c.nome, c.status, c.lat, c.lng]);
            });
            db.run("COMMIT");
            console.log("Status das c√¢meras atualizado via nuvem.");
        }
        
        // Finaliza e recarrega para aplicar as mudan√ßas
        persistir().then(() => {
             showToast("‚úÖ Dados e Status Sincronizados!", "success");
             setTimeout(() => location.reload(), 1500); 
        });

    } catch (e) {
        alert("Falha de conex√£o: " + e.message);
    }
}

async function salvarNaNuvem() {
    if (!confirm("‚ö†Ô∏è Enviar dados locais para a nuvem?")) return;
    showToast("‚òÅÔ∏è Enviando...", "info");

    const resUsers = db.exec("SELECT * FROM usuarios");
    const listaUsuarios = resUsers.length ? sqlToObj(resUsers[0]) : [];
    const payload = { usuarios: listaUsuarios, ocorrencias: OCORRENCIAS };

    try {
        const req = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
            body: JSON.stringify(payload)
        });

        if (req.ok) {
            showToast("‚úÖ Salvo na Nuvem!", "success");
        } else {
            const errData = await req.json();
            alert("Erro ao Salvar: " + (errData.message || "Chave API incorreta"));
        }
    } catch (e) {
        alert("Erro de conex√£o: " + e.message);
    }
}

// ----------------------------------------------------

document.addEventListener('keydown', function(e) {
    if (e.key === "F2") { e.preventDefault(); const cam = CAMERAS.length ? CAMERAS[0].nome : "Manual"; abrirModal(cam, false); }
    if (e.key === "Escape") { fecharModal(); fecharModalEncerrar(); fecharModalUsers(); document.getElementById('modalImgFull').style.display='none'; }
});

function aplicarTravaOperador() {
    const perfil = localStorage.getItem('sicop_perfil') || 'user';
    if (perfil === 'user') {
        const cssTrava = document.createElement("style");
        cssTrava.innerHTML = `.btn-excluir, [onclick*="excluir"], [title*="Excluir"], .fa-trash, .fa-trash-can, .fa-cog, .fa-gear, [title*="Config"], #btnConfig, .fa-database, [title*="Backup"], [title*="Restaurar"], [title*="Limpar"], #btnLimparBanco, #btnAdmin, .admin-only { display: none !important; opacity: 0 !important; pointer-events: none !important; }`;
        document.head.appendChild(cssTrava);
    }
}

function aplicarHierarquia() {
    if (!CURRENT_USER) return;
    const perfil = CURRENT_USER.role.toLowerCase();
    localStorage.setItem('sicop_perfil', perfil);
    const btnAdmin = document.getElementById('btnAdmin');
    if (perfil === 'user' || perfil === 'supervisor') { if(btnAdmin) btnAdmin.classList.add('restrito'); }
}

function finalizarLogin() {
    // SENTINELA: Verifica status no login
    if(CURRENT_USER.status && CURRENT_USER.status !== 'ATIVO') {
        alert("SEU ACESSO EST√Å INATIVO.\nContate o administrador.");
        location.reload();
        return;
    }

    document.getElementById('login').style.display = 'none'; 
    document.getElementById('app').style.display = 'flex';
    const nomeDisplay = CURRENT_USER.nome ? CURRENT_USER.nome : CURRENT_USER.user;
    const orgaoDisplay = CURRENT_USER.orgao ? CURRENT_USER.orgao : 'GMBH';
    document.getElementById('displayUser').innerHTML = `<span style="font-size:0.8rem; color:#aaa">${orgaoDisplay}</span> <strong>${nomeDisplay}</strong>`;
    aplicarHierarquia();
    aplicarTravaOperador();
    iniciarApp();
}

function entrar() {
    let u = document.getElementById('u').value.trim().toUpperCase();
    const p = document.getElementById('p').value;
    
    // Admin Root
    if(u === 'ADMIN' && p === 'admin') { // Em produ√ß√£o mude isso!
        CURRENT_USER = { id: 1, user: 'ADMIN', role: 'admin', nome: 'Administrador', status: 'ATIVO' };
        localStorage.setItem('sicop_perfil', 'admin');
        finalizarLogin();
        return;
    }

    try { 
        const stmt = db.prepare("SELECT * FROM usuarios WHERE user = ? AND pass = ?"); 
        stmt.bind([u.toLowerCase(), p]); 
        if (stmt.step()) {
            CURRENT_USER = stmt.getAsObject(); 
            CURRENT_USER.user = CURRENT_USER.user.toUpperCase(); 
            localStorage.setItem('sicop_perfil', CURRENT_USER.role || 'user');
            finalizarLogin();
        } else {
             // Tenta case insensitive no banco
             const stmt2 = db.prepare("SELECT * FROM usuarios WHERE user = ? AND pass = ?"); 
             stmt2.bind([u, p]);
             if(stmt2.step()){ 
                 CURRENT_USER = stmt2.getAsObject();
                 localStorage.setItem('sicop_perfil', CURRENT_USER.role || 'user');
                 finalizarLogin(); 
             } else {
                 alert("Credenciais Inv√°lidas");
             }
        }
        stmt.free();
    } catch(e) { alert("Erro login: " + e); }
}

const imgDB = new Dexie("Sicop_Fix_V26");
imgDB.version(1).stores({ files: "id, blob" });

let db = null; let map = null; let markers = null; let heatLayer = null; let assetsLayer = null; let pulseLayer = null;
let activeRadius = null; let isRadiusToolActive = false; let isHeatmapOn = false;
let CAMERAS = []; let OCORRENCIAS = []; let LOGS_PLANTAO = []; let STATUS_CAMERAS = {};
let charts = {};
let CURRENT_USER = null; let EDITING_ID = null;
let myLocationMarker = null;

// SENTINELA: Roda a cada 30 segundos
setInterval(verificarStatusUsuario, 30000);

function verificarStatusUsuario() {
    if(!CURRENT_USER || !db) return;
    try {
        const res = db.exec("SELECT status FROM usuarios WHERE id = ?", [CURRENT_USER.id]);
        if(res.length > 0) {
            const st = res[0].values[0][0];
            if(st !== 'ATIVO') {
                alert("üîí SESS√ÉO ENCERRADA\n\nSeu acesso foi revogado pelo administrador.");
                location.reload();
            }
        } else {
             // Usu√°rio deletado
             if(CURRENT_USER.user !== 'ADMIN') { // Protege admin root local
                alert("üîí SESS√ÉO ENCERRADA\n\nUsu√°rio n√£o encontrado.");
                location.reload();
             }
        }
    } catch(e) { console.log("Erro sentinela", e); }
}

function togglePass() { const p=document.getElementById('p'); const i=document.querySelector('.toggle-pass'); if(p.type==='password'){p.type='text';i.classList.remove('fa-eye');i.classList.add('fa-eye-slash')}else{p.type='password';i.classList.remove('fa-eye-slash');i.classList.add('fa-eye')} }
function abrirImagemFull(src) { if(!src)return; document.getElementById('fullImageElement').src=src; document.getElementById('modalImgFull').style.display='flex'; }
function toggleFilter() { const el=document.getElementById('filterContainer'); el.style.display=el.style.display==='block'?'none':'block'; }
function buscarCamSidebar(val) { const items=document.querySelectorAll('.feed-card'); items.forEach(item => { item.style.display=item.innerText.toLowerCase().includes(val.toLowerCase())?'flex':'none'; }); }
function toggleSidebarMobile() { document.getElementById('sidebar').classList.toggle('mobile-open'); }
function resetarSistema() { if(confirm("ATEN√á√ÉO: Isso apagar√° TODOS os dados locais e resetar√° o sistema.\n\nTem certeza absoluta?")) { localStorage.clear(); imgDB.delete().then(() => { alert("Sistema resetado."); location.reload(); }); } }

function startDictation(targetId, btn) {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return alert("Navegador n√£o suporta voz.");
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR'; recognition.interimResults = false;
    recognition.onstart = () => btn.classList.add('listening');
    recognition.onend = () => btn.classList.remove('listening');
    recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; const input = document.getElementById(targetId); if(input) input.value = (input.value + " " + transcript).trim(); };
    recognition.start();
}

// --- FUN√á√ÉO DE LOCALIZA√á√ÉO GPS ---
function localizarUsuario() {
    if (!navigator.geolocation) return alert("Geolocaliza√ß√£o n√£o suportada.");
    showToast("üõ∞Ô∏è Buscando sinal GPS...", "info");
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            if (myLocationMarker) map.removeLayer(myLocationMarker);
            const gpsIcon = L.divIcon({ className: 'gps-pulse-icon', html: '<div class="gps-dot"></div><div class="gps-circle"></div>', iconSize: [20, 20], iconAnchor: [10, 10] });
            myLocationMarker = L.marker([lat, lng], {icon: gpsIcon}).addTo(map);
            myLocationMarker.bindPopup(`<b>üìç Voc√™ est√° aqui</b><br>Precis√£o: ~${Math.round(position.coords.accuracy)}m`).openPopup();
            map.flyTo([lat, lng], 17);
            showToast("‚úÖ Localiza√ß√£o encontrada!", "success");
        },
        (error) => { alert("Erro GPS: " + error.message); }, { enableHighAccuracy: true, timeout: 10000 }
    );
}

function atualizarTudo() {
    let sql = "SELECT * FROM ocorrencias WHERE 1=1"; 
    const params = []; 
    const dt = document.getElementById('filtroData').value;
    
    if (dt && dt.length === 10 && parseInt(dt.split('-')[0]) > 2000) { sql += " AND inicio LIKE ?"; params.push(`${dt}%`); } 
    sql += " ORDER BY inicio DESC";
    
    if(!db) return; 
    const res = db.exec(sql, params); 
    OCORRENCIAS = res.length ? sqlToObj(res[0]) : [];
    
    const resLog = db.exec("SELECT * FROM plantao ORDER BY data DESC LIMIT 50"); 
    LOGS_PLANTAO = resLog.length ? sqlToObj(resLog[0]) : [];
    
    const abertas = OCORRENCIAS.filter(o => o.status === 'ABERTA');
    const hoje = OCORRENCIAS.filter(o => o.inicio.startsWith(new Date().toISOString().split('T')[0])).length;
    
    document.getElementById('k_abertas').innerText = abertas.length; 
    document.getElementById('k_hoje').innerText = hoje;
    
    renderFeed(); renderMap(); renderPlantao(); renderListaCompleta(); renderStatusTab();
    if (document.getElementById('tab-dash').style.display === 'flex') atualizarGraficos();
}

window.onload = async () => {
  aplicarTravaOperador();
  try {
    const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
    const saved = await imgDB.files.get("sqlite_db");
    if (saved) { db = new SQL.Database(new Uint8Array(saved.blob)); } else { db = new SQL.Database(); }
    
    db.run(`CREATE TABLE IF NOT EXISTS ocorrencias (id INTEGER PRIMARY KEY, camera TEXT, area TEXT, gravidade TEXT, motivo TEXT, acao TEXT, obs TEXT, status TEXT, inicio TEXT, fim TEXT, img_id TEXT, resolucao TEXT, fechamento_obs TEXT);`);
    db.run(`CREATE TABLE IF NOT EXISTS plantao (id INTEGER PRIMARY KEY, msg TEXT, data TEXT, usuario TEXT);`);
    db.run(`CREATE TABLE IF NOT EXISTS usuarios (id INTEGER PRIMARY KEY, user TEXT UNIQUE, pass TEXT, role TEXT, nome TEXT, orgao TEXT, status TEXT DEFAULT 'ATIVO');`);
    db.run(`CREATE TABLE IF NOT EXISTS status_cameras (nome TEXT PRIMARY KEY, status TEXT, obs TEXT, data_update TEXT);`);
    db.run("INSERT OR IGNORE INTO usuarios (user, pass, role, nome, orgao, status) VALUES ('admin', 'admin', 'admin', 'Administrador', 'COP', 'ATIVO')");

    try { db.run("ALTER TABLE ocorrencias ADD COLUMN lat REAL"); } catch(e) {}
    try { db.run("ALTER TABLE ocorrencias ADD COLUMN lng REAL"); } catch(e) {}
    try { db.run("ALTER TABLE ocorrencias ADD COLUMN endereco TEXT"); } catch(e) {}
    try { db.run("ALTER TABLE ocorrencias ADD COLUMN img_fim_id TEXT"); } catch(e) {}
    try { db.run("ALTER TABLE usuarios ADD COLUMN nome TEXT"); } catch(e) {}
    try { db.run("ALTER TABLE usuarios ADD COLUMN orgao TEXT"); } catch(e) {}
    try { db.run("ALTER TABLE usuarios ADD COLUMN status TEXT DEFAULT 'ATIVO'"); } catch(e) {}

    const resStatus = db.exec("SELECT * FROM status_cameras");
    if(resStatus.length) { resStatus[0].values.forEach(row => { STATUS_CAMERAS[row[0]] = { status: row[1], obs: row[2], data: row[3] }; }); }

    persistir(); 

    const cams = localStorage.getItem('sicop_cams_v26');
    CAMERAS = cams ? JSON.parse(cams) : [{nome:'CAM-TESTE-01', lat:-19.916681, lng:-43.934493, area:'1 BPM'}];

    document.getElementById('loader').style.display='none'; 
    document.getElementById('loginForm').style.display='block';
  } catch(e) { document.getElementById('loader').style.display='none'; document.getElementById('loginForm').style.display='block'; alert("Erro Cr√≠tico ao iniciar DB."); }
};

function atualizarStatusEEndereco(camName) {
    atualizarEndAutomatico(camName);
    const st = STATUS_CAMERAS[camName] ? STATUS_CAMERAS[camName].status : 'ONLINE';
    document.getElementById('quickStatus').value = st;
}

function quickUpdateStatus() {
    const cam = document.getElementById('selCam').value;
    const novoStatus = document.getElementById('quickStatus').value;
    if(!cam || cam === 'MANUAL') return;

    db.run("INSERT OR REPLACE INTO status_cameras (nome, status, obs, data_update) VALUES (?, ?, ?, ?)", [cam, novoStatus, "Via Quick Menu", new Date().toISOString()]);
    STATUS_CAMERAS[cam] = { status: novoStatus, obs: "Via Quick Menu", data: new Date().toISOString() };
    persistir();
    showToast(`Status de ${cam} atualizado para: ${novoStatus}`, "info");
    atualizarTudo();
}

function renderStatusTab() {
    const div = document.getElementById('listaStatus'); div.innerHTML = '';
    let off = 0; let manu = 0;
    Object.keys(STATUS_CAMERAS).forEach(cam => {
        const dados = STATUS_CAMERAS[cam];
        if(dados.status === 'ONLINE') return; 
        if(dados.status === 'OFFLINE') off++;
        if(dados.status === 'MANUTENCAO') manu++;
        const card = document.createElement('div');
        card.className = `status-card ${dados.status.toLowerCase()}`;
        card.innerHTML = `<div><strong>${cam}</strong><small>${dados.status} - ${new Date(dados.data).toLocaleDateString()}</small></div><button class="btn btn-dark btn-compact" onclick="focarOcorrencia('${cam}')"><i class="fa-solid fa-crosshairs"></i></button>`;
        div.appendChild(card);
    });
    document.getElementById('st_off').innerText = off;
    document.getElementById('st_manu').innerText = manu;
}

function abrirSobre() { document.getElementById('modalSobre').style.display='flex'; }

function encerrarPlantaoZap() {
    if(!confirm("‚ö†Ô∏è Deseja encerrar o plant√£o e enviar o relat√≥rio para o WhatsApp?")) return;
    const abertas = OCORRENCIAS.filter(o => o.status === 'ABERTA').length;
    const hoje = OCORRENCIAS.filter(o => o.inicio.startsWith(new Date().toISOString().split('T')[0])).length;
    const texto = `üö® *RELAT√ìRIO DE PLANT√ÉO - SICOP* üö®%0A%0A` + `üëÆ‚Äç‚ôÇÔ∏è *Operador:* ${CURRENT_USER ? CURRENT_USER.user : 'An√¥nimo'}%0A` + `üìÖ *Data:* ${new Date().toLocaleDateString()}%0A` + `üìä *RESUMO:*%0A` + `‚úÖ Totais: ${hoje}%0A` + `‚ö†Ô∏è Pendentes: ${abertas}%0A` + `‚úÖ *Sistema OK*`;
    window.open(`https://wa.me/?text=${texto}`, '_blank');
    setTimeout(() => { if(confirm("Relat√≥rio enviado! Sair do sistema?")) { location.reload(); } }, 1000);
}

function exportarDadosTurno() {
    const dados = JSON.stringify(OCORRENCIAS);
    const blob = new Blob([dados], {type: "application/json"});
    saveAs(blob, `SICOP_Dados_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`);
    alert("Arquivo JSON gerado!");
}

function exportarCSV() {
    let csv = "ID,Data,Camera,Endereco,Motivo,Gravidade,Status,Obs\n";
    OCORRENCIAS.forEach(o => {
        const obsLimpa = o.obs ? o.obs.replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""') : "";
        csv += `${o.id},"${o.inicio}","${o.camera}","${o.endereco||''}","${o.motivo}","${o.gravidade}","${o.status}","${obsLimpa}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    saveAs(blob, `SICOP_Relatorio_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
}

async function fazerBackup() {
    if (!confirm("Exportar Backup Completo?")) return;
    const z = new JSZip();
    try {
        const data = db.export();
        z.file("sicop_database.sqlite", data);
        const statusExport = JSON.stringify(STATUS_CAMERAS, null, 2);
        z.file("relatorio_status_cameras.json", statusExport);
        const fotos = await imgDB.files.toArray();
        const pastaMidia = z.folder("midia");
        fotos.forEach(item => { if (item.id !== 'sqlite_db') pastaMidia.file(item.id, item.blob); });
        z.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, `SICOP_BACKUP_${new Date().toLocaleDateString().replace(/\//g, '-')}.zip`);
            showToast("‚úÖ ZIP GERADO!", "success");
        });
    } catch (e) { alert("Erro backup: " + e); }
}

async function restaurarBackup(input) {
    try {
        const z = await new JSZip().loadAsync(input.files[0]);
        const arquivoZip = z.file("sicop_database.sqlite");
        if (!arquivoZip) return alert("Erro: Arquivo SQLite n√£o encontrado no ZIP.");

        const sqlFile = await arquivoZip.async("uint8array");
        db = new SQL.Database(sqlFile);
        await persistir(); 
        
        const pastaMidia = z.folder("midia");
        const promessas = [];
        if(pastaMidia) {
            pastaMidia.forEach((caminho, arquivo) => {
                promessas.push(arquivo.async("blob").then(blob => {
                    return imgDB.files.put({ id: arquivo.name.replace("midia/", ""), blob: blob });
                }));
            });
        }
        await Promise.all(promessas);
        alert("‚úÖ BACKUP RESTAURADO!");
        location.reload(); 
    } catch (e) { alert("Erro restaurar: " + e.message); }
}

async function importarDadosTurno(input) {
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const dados = JSON.parse(e.target.result);
            if (!Array.isArray(dados)) return;
            OCORRENCIAS = [...OCORRENCIAS, ...dados];
            renderFeed(); renderMap(); renderListaCompleta();
            alert(`‚úÖ IMPORTADO: ${dados.length} ocorr√™ncias.`);
        } catch(err) { alert("ERRO: Arquivo inv√°lido."); }
    };
    reader.readAsText(input.files[0]);
}

function iniciarApp() { initMap(); atualizarTudo(); atualizarSelectAreas(); getWeather(); setInterval(getWeather, 600000); }
async function persistir() { const data = db.export(); await imgDB.files.put({ id: "sqlite_db", blob: data }); }

async function getWeather() {
    try {
        const lat = CAMERAS.length ? CAMERAS[0].lat : -19.92; 
        const lng = CAMERAS.length ? CAMERAS[0].lng : -43.94;
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
        const data = await res.json();
        document.getElementById('w-temp').innerText = `${data.current_weather.temperature}¬∞C`;
    } catch(e) {}
}

function renderMap() {
  markers.clearLayers(); pulseLayer.clearLayers(); 
  if(myLocationMarker) myLocationMarker.addTo(map);

  if(isHeatmapOn) return; 
  const filtroArea = document.getElementById('filtroArea').value;

  CAMERAS.forEach(c => {
    if (filtroArea !== 'TODOS' && c.area !== filtroArea) return;
    const st = STATUS_CAMERAS[c.nome] || { status: 'ONLINE' };
    const oc = OCORRENCIAS.find(o => o.camera === c.nome && o.status === 'ABERTA');
    let iconHtml = '<i class="fa-solid fa-video"></i>'; 
    let pinClass = '';
    
    if (st.status === 'OFFLINE') pinClass = 'pin-offline';
    if (st.status === 'MANUTENCAO') pinClass = 'pin-manutencao';
    
    if (oc) {
      let color = '#10b981';
      if (oc.gravidade === 'ALERTA') color = '#f59e0b';
      if (oc.gravidade === 'CRITICO') color = '#ef4444';
      pinClass = oc.gravidade === 'CRITICO' ? 'pin-critico' : (oc.gravidade === 'ALERTA' ? 'pin-alerta' : 'pin-obs');
      
      const pulseIcon = L.divIcon({ className: 'pulse-animation-icon', html: `<div class="pulse-circle" style="color:${color}; border-color:${color}; background:${color}"></div>`, iconSize: [60, 60], iconAnchor: [30, 50] });
      L.marker([c.lat, c.lng], {icon: pulseIcon}).addTo(pulseLayer);
    }
    
    const styleOverride = (st.status !== 'ONLINE' && !oc) ? `style="background:${st.status === 'OFFLINE' ? '#dc2626' : '#eab308'}"` : '';
    const m = L.marker([c.lat, c.lng], { icon: L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin ${pinClass}" ${styleOverride}>${iconHtml}</div>`, iconSize: [40, 42], iconAnchor: [20, 42], popupAnchor: [0, -35] }) });
    m.cameraNome = c.nome;

    let popup = `<b>${c.nome}</b><br>${c.area || ''}`;
    if(st.status !== 'ONLINE') popup += `<br><span style="color:${st.status==='OFFLINE'?'red':'orange'}">‚ö†Ô∏è ${st.status}</span>`;
    if(oc) popup += `<hr><b style="color:${pinClass === 'pin-critico' ? 'red' : 'orange'}">${oc.motivo}</b><br>${oc.acao}<br><button onclick="editarOcorrencia(${oc.id})" class="btn-edit" style="width:100%;margin-top:5px">Editar</button>`; 
    else popup += `<br><button onclick="abrirModal('${c.nome}')" class="btn btn-primary" style="margin-top:5px;width:100%">Abrir / Status</button>`; 
    
    m.bindPopup(popup); 
    markers.addLayer(m);
  });

  const manuais = OCORRENCIAS.filter(o => o.area === 'MANUAL' && o.status === 'ABERTA');
  manuais.forEach(o => {
      if(o.lat && o.lng) {
          const iconHtml = '<i class="fa-solid fa-location-dot"></i>';
          const pinClass = o.gravidade === 'CRITICO' ? 'pin-critico' : (o.gravidade === 'ALERTA' ? 'pin-alerta' : 'pin-obs');
          let color = '#10b981';
          if (o.gravidade === 'ALERTA') color = '#f59e0b';
          if (o.gravidade === 'CRITICO') color = '#ef4444';

          const pulseIcon = L.divIcon({ className: 'pulse-animation-icon', html: `<div class="pulse-circle" style="color:${color}; border-color:${color}; background:${color}"></div>`, iconSize: [60, 60], iconAnchor: [30, 50] });
          L.marker([o.lat, o.lng], {icon: pulseIcon}).addTo(pulseLayer);

          const m = L.marker([o.lat, o.lng], { icon: L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin ${pinClass}">${iconHtml}</div>`, iconSize: [40, 42], iconAnchor: [20, 42], popupAnchor: [0, -35] }) });
          m.cameraNome = o.camera;
          m.bindPopup(`<b>üìç ${o.endereco || 'Local Manual'}</b><hr><b>${o.motivo}</b><br>${o.obs}<br><button onclick="editarOcorrencia(${o.id})" class="btn-edit" style="width:100%;margin-top:5px">Editar</button>`);
          markers.addLayer(m);
      }
  });
}

function toggleHeatmap() { isHeatmapOn = !isHeatmapOn; const btn = document.getElementById('btnHeat'); if (isHeatmapOn) { btn.classList.add('active'); markers.clearLayers(); pulseLayer.clearLayers(); const points = OCORRENCIAS.map(o => { const c = CAMERAS.find(cam => cam.nome === o.camera); return c ? [c.lat, c.lng, 1.0] : null; }).filter(p => p); if(points.length) heatLayer = L.heatLayer(points, {radius: 25, blur: 15}).addTo(map); } else { btn.classList.remove('active'); if (heatLayer) map.removeLayer(heatLayer); renderMap(); } }
function toggleRadiusTool() { isRadiusToolActive = !isRadiusToolActive; document.getElementById('btnRadius').classList.toggle('active'); if(!isRadiusToolActive) removerZona(); }

async function atualizarEndAutomatico(val) {
    const input = document.getElementById('endAutomatico');
    input.value = "Buscando endere√ßo...";
    let lat, lng;
    if(val === "MANUAL" && tempManualLocation) { lat = tempManualLocation.lat; lng = tempManualLocation.lng; }
    else { const c = CAMERAS.find(x => x.nome === val); if(c){ lat = c.lat; lng = c.lng; } }

    if(lat && lng) {
        const end = await buscarEndereco(lat, lng);
        input.value = end;
    } else { input.value = ""; }
}

function abrirModal(c, isManual = false) { 
    EDITING_ID = null;
    document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="color:var(--warn)"></i> Nova Ocorr√™ncia';
    document.getElementById('btnSave').innerText = "CONFIRMAR";
    document.getElementById('btnSave').disabled = false; 
    document.getElementById('editFileNote').style.display='none';
    document.getElementById('selGrav').value = 'OBSERVACAO'; 
    document.getElementById('selMot').value = 'ACIDENTE'; 
    document.getElementById('selAcao').value = 'MONITORAMENTO'; 
    document.getElementById('txtObs').value = ''; 
    document.getElementById('fileImg').value = '';
    
    atualizarStatusEEndereco(c && !isManual ? c : '');
    const s = document.getElementById('selCam'); s.innerHTML=''; 
    if (isManual) {
        const o = document.createElement('option'); o.value = "MANUAL"; o.innerText = "üìç " + c; o.selected = true; s.appendChild(o); s.disabled = true; 
        document.getElementById('endAutomatico').value = c; 
    } else {
        tempManualLocation = null; s.disabled = false;
        CAMERAS.forEach(cam => { const o=document.createElement('option'); o.value=cam.nome; o.innerText=cam.nome; if(cam.nome===c) o.selected=true; s.appendChild(o); }); 
        atualizarEndAutomatico(c); 
    }
    document.getElementById('modal').style.display='flex'; 
}

function verStreetView() {
    let lat, lng;
    const selCam = document.getElementById('selCam');
    if(selCam.value === "MANUAL" && tempManualLocation) { lat = tempManualLocation.lat; lng = tempManualLocation.lng; } 
    else { const cam = CAMERAS.find(c => c.nome === selCam.value); if(cam) { lat = cam.lat; lng = cam.lng; } }
    if(lat && lng) { window.open(`https://www.google.com/maps?q&layer=c&cbll=${lat},${lng}`, '_blank'); } 
    else { alert("Selecione uma c√¢mera ou local manual primeiro."); }
}

function focarOcorrencia(nome) {
    let targetLayer = null;
    markers.eachLayer(function(layer) { if (layer.cameraNome === nome) targetLayer = layer; });

    if (targetLayer) {
        mudarTab('mapa');
        markers.zoomToShowLayer(targetLayer, function() { targetLayer.openPopup(); });
    } else {
        let lat, lng;
        const cam = CAMERAS.find(c => c.nome === nome);
        if(cam) { lat = cam.lat; lng = cam.lng; } 
        else {
            const oc = OCORRENCIAS.find(o => o.camera === nome && o.status === 'ABERTA');
            if(oc && oc.lat && oc.lng) { lat = oc.lat; lng = oc.lng; }
        }
        if(lat && lng) { mudarTab('mapa'); map.flyTo([lat, lng], 18); } 
        else { alert("Localiza√ß√£o n√£o encontrada ou filtrada no mapa."); }
    }
}

function fecharModal() { document.getElementById('modal').style.display='none'; }

function salvarOcorrencia() {
  const btnSave = document.getElementById('btnSave'); btnSave.disabled = true; btnSave.innerText = "Salvando...";
  try {
      const selCam = document.getElementById('selCam');
      const isManual = selCam.value === "MANUAL";
      let nomeFinal = selCam.value; let latF = null; let lngF = null;

      if (isManual) {
          if (tempManualLocation) { nomeFinal = tempManualLocation.nome; latF = tempManualLocation.lat; lngF = tempManualLocation.lng; } 
          else { btnSave.disabled = false; btnSave.innerText = "CONFIRMAR"; return alert("Erro: Localiza√ß√£o manual n√£o detectada."); }
      } else {
          nomeFinal = selCam.value; const c = CAMERAS.find(x => x.nome === nomeFinal); if (c) { latF = c.lat; lngF = c.lng; }
      }

      const area = isManual ? 'MANUAL' : (CAMERAS.find(c => c.nome === nomeFinal)?.area || 'GERAL');
      const enderecoSalvo = document.getElementById('endAutomatico').value; 
      const file = document.getElementById('fileImg').files[0];
      const imgId = file ? `img_${Date.now()}` : null;
      
      const finishSave = () => {
          try {
              if(EDITING_ID === null) {
                  db.run(`INSERT INTO ocorrencias (camera, area, gravidade, motivo, acao, obs, status, inicio, img_id, lat, lng, endereco) VALUES (?,?,?,?,?,?,'ABERTA',?,?,?,?,?)`, 
                  [nomeFinal, area, document.getElementById('selGrav').value, document.getElementById('selMot').value, document.getElementById('selAcao').value, document.getElementById('txtObs').value, new Date().toISOString(), imgId, latF, lngF, enderecoSalvo]);
              } else {
                  let sql = "UPDATE ocorrencias SET gravidade=?, motivo=?, acao=?, obs=?, endereco=?";
                  let params = [document.getElementById('selGrav').value, document.getElementById('selMot').value, document.getElementById('selAcao').value, document.getElementById('txtObs').value, enderecoSalvo];
                  if(imgId) { sql += ", img_id=?"; params.push(imgId); } 
                  sql += " WHERE id=?"; params.push(EDITING_ID);
                  db.run(sql, params);
              }
              persistir().then(() => { fecharModal(); atualizarTudo(); tempManualLocation = null; btnSave.disabled = false; });
          } catch (errSQL) { alert("ERRO BANCO: " + errSQL.message); btnSave.disabled = false; btnSave.innerText = "CONFIRMAR"; }
      };

      if (file) { imgDB.files.put({ id: imgId, blob: file }).then(finishSave).catch(e => { alert("Erro ao salvar imagem: " + e); btnSave.disabled = false; }); } 
      else { finishSave(); }
  } catch (e) { alert("Erro cr√≠tico salvar: " + e.message); btnSave.disabled = false; }
}

function editarOcorrencia(id) {
    const o = OCORRENCIAS.find(x => x.id === id); if (!o) return;
    if(o.status === 'ENCERRADA' && CURRENT_USER.role !== 'admin') return alert("Apenas Admin pode reabrir.");
    EDITING_ID = id;
    document.getElementById('modalTitle').innerText = "Editar Ocorr√™ncia #" + id;
    document.getElementById('btnSave').innerText = "ATUALIZAR";
    document.getElementById('btnSave').disabled = false;
    document.getElementById('quickStatus').value = 'ONLINE';
    const sel = document.getElementById('selCam'); sel.innerHTML = '';
    const camExiste = CAMERAS.find(c => c.nome === o.camera);
    if (camExiste) {
        CAMERAS.forEach(cam => { const opt = document.createElement('option'); opt.value = cam.nome; opt.innerText = cam.nome; if(cam.nome === o.camera) opt.selected = true; sel.appendChild(opt); });
        sel.disabled = false;
    } else {
        const opt = document.createElement('option'); opt.value = o.camera; opt.innerText = o.camera; opt.selected = true; sel.appendChild(opt); sel.disabled = true;
    }
    document.getElementById('selGrav').value = o.gravidade;
    document.getElementById('selMot').value = o.motivo;
    document.getElementById('selAcao').value = o.acao || 'MONITORAMENTO';
    document.getElementById('txtObs').value = o.obs;
    document.getElementById('endAutomatico').value = o.endereco || ''; 
    document.getElementById('editFileNote').style.display = 'block';
    document.getElementById('modal').style.display = 'flex';
}

function initMap() {
  if (map) return;
  const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'Esri'});
  const topo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {attribution:'Esri', maxZoom: 19});
  const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution:'CartoDB'});
  map = L.map('map', { layers: [sat], zoomControl: false }).setView([-19.92, -43.94], 13);
  L.control.layers({"Sat√©lite": sat, "Topogr√°fico": topo, "T√°tico": dark}).addTo(map);
  L.control.zoom({position:'bottomright'}).addTo(map);
  markers = L.markerClusterGroup({ disableClusteringAtZoom: 16 }); map.addLayer(markers);
  assetsLayer = L.layerGroup().addTo(map); pulseLayer = L.layerGroup().addTo(map);

  map.on('click', async function(e) {
      if(isRadiusToolActive) { 
          if(activeRadius) map.removeLayer(activeRadius); 
          activeRadius = L.circle(e.latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.15, weight: 1, radius: 500 }).addTo(map); 
          const div = document.createElement('div'); div.innerHTML = "<b>Zona</b><br><button onclick='removerZona()' style='background:#ef4444;color:white;border:none;margin-top:5px;cursor:pointer;padding:3px 6px;border-radius:3px'>Remover</button>"; 
          activeRadius.bindPopup(div).openPopup(); isRadiusToolActive = false; document.getElementById('btnRadius').classList.remove('active'); return;
      }
      if(isPinMode) {
          const lat = e.latlng.lat; const lng = e.latlng.lng; document.getElementById('map').style.cursor = 'wait'; 
          const endereco = await buscarEndereco(lat, lng);
          document.getElementById('map').style.cursor = 'crosshair';
          tempManualLocation = { lat: lat, lng: lng, nome: endereco }; 
          abrirModal(endereco, true); togglePinMode(); 
      }
  });
}

window.removerZona = function() { if(activeRadius) { map.removeLayer(activeRadius); activeRadius = null; } }

let isPinMode = false; let tempManualLocation = null;
function togglePinMode() {
    isPinMode = !isPinMode; const btn = document.getElementById('btnPin');
    if(btn) {
        if (isPinMode) { btn.classList.add('active'); btn.style.background = 'var(--accent)'; document.getElementById('map').style.cursor = 'crosshair'; showToast("üìç Clique no mapa para abrir ocorr√™ncia", "info"); } 
        else { btn.classList.remove('active'); btn.style.background = ''; document.getElementById('map').style.cursor = ''; }
    }
}

async function buscarEndereco(lat, lng) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await res.json();
        return data.display_name.split(',')[0] + " - " + (data.address.suburb || data.address.city || "BH"); 
    } catch (e) { return `Coord: ${lat.toFixed(5)}, ${lng.toFixed(5)}`; }
}

async function irParaEndereco(query) {
    if(!query || query.length < 4) return;
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}, Belo Horizonte, MG, Brazil&limit=1`);
        const data = await res.json();
        if(data && data.length > 0) {
            const lat = parseFloat(data[0].lat); const lng = parseFloat(data[0].lon);
            map.flyTo([lat, lng], 16);
            L.popup().setLatLng([lat, lng]).setContent("üìç " + data[0].display_name.split(',')[0]).openOn(map);
        } else { alert("Endere√ßo n√£o encontrado."); }
    } catch(e) { console.error(e); }
}

function gerarRelatorioBI() {
    let csv = "\uFEFFID;DATA;CAMERA;ENDERECO;NATUREZA;GRAVIDADE;STATUS;RESOLUCAO\n";
    OCORRENCIAS.forEach(o => {
        const endLimpo = (o.endereco || "").replace(/;/g, ",").replace(/(\r\n|\n|\r)/gm, " ");
        csv += `${o.id};${o.inicio};${o.camera};${endLimpo};${o.motivo};${o.gravidade};${o.status};${o.resolucao || 'EM ANDAMENTO'}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    saveAs(blob, `DADOS_BI_GMBH_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
    alert("üìä DADOS BI GERADOS!");
}

function exportarRelatorioExecutivo() {
  const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); 
  doc.setFillColor(15, 23, 42); doc.rect(0, 0, 297, 30, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(18); doc.text("REGISTRO GLOBAL DE OCORR√äNCIAS - GMBH", 14, 15); 
  doc.setFontSize(10); doc.setTextColor(200, 200, 200); doc.text(`Extra√≠do em: ${new Date().toLocaleString()}`, 14, 25);
  const rows = OCORRENCIAS.map(r => [ r.id, new Date(r.inicio).toLocaleString(), r.camera, r.endereco || '---', r.motivo, r.gravidade, r.status, r.resolucao || '-' ]);
  doc.autoTable({ head: [['ID', 'Data/Hora', 'Ref. Local', 'Endere√ßo', 'Natureza', 'N√≠vel', 'Status', 'Desfecho']], body: rows, startY: 40, theme: 'grid', headStyles: { fillColor: [37, 99, 235], textColor: 255 }, styles: { fontSize: 8 } });
  doc.save(`Relatorio_Global_GMBH_${new Date().toLocaleDateString().replace(/\//g,'-')}.pdf`);
}

function gerarRelatorioStatusPDF() {
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    doc.setFillColor(220, 38, 38); doc.rect(0, 0, 210, 25, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text("RELAT√ìRIO T√âCNICO - C√ÇMERAS INOPERANTES", 14, 15);
    const rows = [];
    Object.keys(STATUS_CAMERAS).forEach(cam => {
        const dados = STATUS_CAMERAS[cam];
        if (dados.status !== 'ONLINE') { rows.push([ cam, dados.status, dados.obs || 'Sem observa√ß√£o', new Date(dados.data).toLocaleString() ]); }
    });
    if (rows.length === 0) return alert("Todas as c√¢meras operacionais!");
    doc.autoTable({ head: [['C√ÇMERA', 'STATUS', 'DIAGN√ìSTICO', 'DATA']], body: rows, startY: 35, theme: 'grid', headStyles: { fillColor: [60, 60, 60], textColor: 255 } });
    doc.save(`Relatorio_Tecnico_${new Date().toLocaleDateString().replace(/\//g,'-')}.pdf`);
}

function atualizarGraficos() { 
  const count = (arr, k) => { const c={}; arr.forEach(x=>{c[x[k]]=(c[x[k]]||0)+1}); return c; }; 
  const render = (id, type, labels, data, colors) => { 
      const canvas = document.getElementById(id); if(charts[id]) { charts[id].destroy(); }
      charts[id] = new Chart(canvas, { type: type, data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderColor: '#1e293b', borderWidth: 2 }] }, options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { labels: { color: 'white', font: {size: 11} }, position: 'bottom' } }, scales: type === 'bar' || type === 'line' ? { y: { ticks: { color: 'white' }, grid: {color: '#334155'} }, x: { ticks: { color: 'white' }, grid: {display: false} } } : {} } }); 
  }; 
  render('chartMotivo', 'doughnut', Object.keys(count(OCORRENCIAS,'motivo')), Object.values(count(OCORRENCIAS,'motivo')), ['#3b82f6','#ef4444','#10b981','#f59e0b', '#8b5cf6']); 
  render('chartGravidade', 'pie', Object.keys(count(OCORRENCIAS,'gravidade')), Object.values(count(OCORRENCIAS,'gravidade')), ['#ef4444','#f59e0b','#10b981']); 
  render('chartArea', 'bar', Object.keys(count(OCORRENCIAS,'area')), Object.values(count(OCORRENCIAS,'area')), '#22d3ee'); 
  const last7={}; for(let i=6;i>=0;i--){let d=new Date();d.setDate(d.getDate()-i);last7[d.toISOString().split('T')[0]]=0;} 
  OCORRENCIAS.forEach(o=>{const k=o.inicio.split('T')[0];if(last7[k]!==undefined)last7[k]++}); 
  render('chartTempo', 'line', Object.keys(last7), Object.values(last7), '#3b82f6'); 
}

function renderFeed() {
  const div = document.getElementById('feed'); 
  div.innerHTML = '';
  const now = new Date();
  
  // Pegamos as √∫ltimas 50 abertas para n√£o pesar o sistema
  const ultimas = OCORRENCIAS.filter(o => o.status === 'ABERTA').slice(0, 50);
  
  for (const o of ultimas) {
    const card = document.createElement('div'); 
    card.className = 'feed-card'; 
    const cor = o.gravidade === 'CRITICO' ? '#ef4444' : (o.gravidade === 'ALERTA' ? '#f59e0b' : '#10b981');
    card.style.borderLeft = `4px solid ${cor}`;
    
    const diffMin = Math.floor((now - new Date(o.inicio)) / 60000);
    const tempoTexto = diffMin < 60 ? `${diffMin} min` : `${Math.floor(diffMin/60)}h ${diffMin%60}min`;
    
    // O HTML do Card: Detalhes e Imagem ficam Ocultos (display:none pelo CSS) at√© expandir
    card.innerHTML = `
      <div class="feed-header" onclick="this.parentElement.classList.toggle('expanded')">
        <div class="feed-info">
            <span class="cam-name">${o.camera} <span class="cam-reason">- ${o.motivo}</span></span>
            <small style="color:#aaa">${o.endereco || ''}</small>
            <div class="cam-meta">
                <span><i class="fa-regular fa-clock"></i> ${tempoTexto}</span>
                <span style="color:${cor}; font-weight:bold; font-size:0.7rem; border:1px solid ${cor}; padding:0 4px; border-radius:4px">${o.gravidade}</span>
            </div>
        </div>
        <div style="font-size:1.2rem; color:#64748b; margin-left:10px"><i class="fa-solid fa-chevron-down"></i></div>
      </div>
      
      <div class="feed-details">
        ${o.img_id ? `<img id="thumb-${o.id}" class="feed-preview-img" style="display:block; width:100%; height:150px; object-fit:cover; margin-bottom:10px; cursor:pointer" onclick="mostrarImg('${o.img_id}')" src="" title="Clique para ampliar">` : ''}
        
        <div class="feed-desc" style="padding:10px; color:#ccc; font-size:0.85rem; background: rgba(0,0,0,0.2); border-radius:4px; margin-bottom:10px">
            ${o.obs || 'Sem observa√ß√µes detalhadas.'}
        </div>
        
        <div class="action-row" style="display:flex; gap:5px; padding:5px 0">
            <button onclick="focarOcorrencia('${o.camera}')" class="btn btn-dark" title="Localizar no Mapa" style="flex:1; padding:8px">
                <i class="fa-solid fa-crosshairs"></i>
            </button>
            <button onclick="editarOcorrencia(${o.id})" class="btn btn-edit" title="Editar" style="flex:1; padding:8px">
                <i class="fa-solid fa-pen"></i>
            </button>
            <button onclick="shareWhatsApp(${o.id})" class="btn btn-whatsapp" title="Enviar para WhatsApp" style="flex:1; padding:8px; background:#25D366; color:white; border:none; border-radius:6px; cursor:pointer">
                <i class="fa-brands fa-whatsapp"></i>
            </button>
            <button onclick="abrirModalEncerrar(${o.id})" class="btn-primary" style="flex:2; padding:8px; border-radius:6px; font-weight:bold">
                RESOLVER
            </button>
        </div>
      </div>`;
      
    div.appendChild(card);

    // S√≥ carrega o arquivo de imagem se houver ID
    if(o.img_id) {
        loadThumb(o.id, o.img_id);
    }
  }
}

async function loadThumb(oid, imgid) {
    try {
        const f = await imgDB.files.get(imgid);
        if(f) {
            const url = URL.createObjectURL(f.blob);
            const el = document.getElementById('thumb-'+oid);
            if(el) { 
                el.src = url; 
                el.style.display = 'block'; 
            }
        }
    } catch(e) { console.log('Erro thumb', e); }
}

async function mostrarImg(id) {
    const f = await imgDB.files.get(id);
    if(f) {
        document.getElementById('fullImageElement').src = URL.createObjectURL(f.blob);
        document.getElementById('modalImgFull').style.display='flex';
    }
}

function renderListaCompleta() {
    const tbody = document.getElementById('tabelaListaGeral'); tbody.innerHTML = '';
    OCORRENCIAS.forEach(o => {
        const tr = document.createElement('tr');
        const cor = o.status === 'ABERTA' ? '#f59e0b' : '#10b981';
        const podeEditar = o.status === 'ABERTA' || (CURRENT_USER && CURRENT_USER.role === 'admin');
        const btnAcao = podeEditar ? `<button class="btn btn-edit" style="padding:4px 8px; font-size:0.75rem" onclick="${o.status==='ABERTA' ? `abrirModalEncerrar(${o.id})` : `editarOcorrencia(${o.id})`}">${o.status==='ABERTA'?'Resolver':'Reabrir/Editar'}</button>` : '';
        tr.innerHTML = `<td>#${o.id}</td><td>${new Date(o.inicio).toLocaleString()}</td><td><strong>${o.camera}</strong><br><small style="color:#94a3b8">${o.endereco || '---'}</small></td><td>${o.motivo}</td><td><span style="padding:4px 8px; border-radius:4px; background:${cor}; color:black; font-weight:bold; font-size:0.7rem">${o.status}</span></td><td><button class="btn btn-dark" style="padding:4px 8px; font-size:0.75rem" onclick="focarOcorrencia('${o.camera}')">Ver no Mapa</button> ${btnAcao}</td>`;
        tbody.appendChild(tr);
    });
}

function renderPlantao() { const l = document.getElementById('logList'); l.innerHTML = ''; LOGS_PLANTAO.forEach(x => { const d=document.createElement('div'); d.className='log-item'; d.innerHTML=`<span class="log-time">${new Date(x.data).toLocaleTimeString()}</span> ${x.msg}`; l.appendChild(d); }); }
function adicionarLog() { const t = document.getElementById('logInput').value; if(!t)return; db.run("INSERT INTO plantao (msg,data,usuario) VALUES (?,?,?)", [t,new Date().toISOString(),CURRENT_USER ? CURRENT_USER.user : 'Anon']); persistir(); document.getElementById('logInput').value=''; atualizarTudo(); }
function shareWhatsApp(id) { const o = OCORRENCIAS.find(x => x.id === id); if(!o) return; const txt = `üö® *OCORR√äNCIA #${o.id}*\nüìç ${o.camera}\n‚ö†Ô∏è ${o.gravidade}\nüìù ${o.obs}`; window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank'); }

function abrirModalEncerrar(id) { document.getElementById('idEncerrar').value = id; document.getElementById('resObs').value = ''; document.getElementById('modalEncerrar').style.display = 'flex'; }
function fecharModalEncerrar() { document.getElementById('modalEncerrar').style.display = 'none'; }
async function confirmarEncerramento() {
    const id = document.getElementById('idEncerrar').value; const tipo = document.getElementById('resTipo').value; const obs = document.getElementById('resObs').value;
    if (!obs) return alert("Digite um relat√≥rio.");
    const fileFim = document.getElementById('fileImgFim').files[0]; let imgFimId = null;
    if (fileFim) { imgFimId = `img_fim_${Date.now()}`; await imgDB.files.put({ id: imgFimId, blob: fileFim }); }
    db.run(`UPDATE ocorrencias SET status = 'ENCERRADA', fim = ?, resolucao = ?, fechamento_obs = ?, img_fim_id = ? WHERE id = ?`, [new Date().toISOString(), tipo, obs, imgFimId, id]);
    await persistir(); showToast("Encerrado!", "success"); fecharModalEncerrar(); atualizarTudo();
}

function mudarTab(t) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); event.target.classList.add('active'); if(t==='mapa'&&map) setTimeout(()=>map.invalidateSize(),100); if(t==='dash') atualizarGraficos(); }
function atualizarSelectAreas() { const s = document.getElementById('filtroArea'); s.innerHTML='<option value="TODOS">Todas √Åreas</option>'; new Set(CAMERAS.map(c=>c.area||'GERAL')).forEach(a=>{const o=document.createElement('option');o.value=a;o.innerText=a;s.appendChild(o)}); }
function limparFiltroData(){ document.getElementById('filtroData').value=''; atualizarTudo(); }
function buscarCam(v){ if(v.length<3)return; const c=CAMERAS.find(x=>x.nome.toLowerCase().includes(v.toLowerCase())); if(c) { focarOcorrencia(c.nome); } }
function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { if (document.exitFullscreen) { document.exitFullscreen(); } } }

// Adiciona recursos (Assets) no mapa
function addAsset(type) {
  const prefixo = prompt(`Prefixo da ${type === 'PM' ? 'Viatura' : 'Unidade'}:`);
  if(!prefixo) return;
  const center = map.getCenter();
  let iconHtml = ''; let cssClass = '';
  if (type === 'PM') { iconHtml = '<i class="fa-solid fa-car-side"></i>'; cssClass = 'asset-pm'; } 
  else { iconHtml = '<i class="fa-solid fa-truck-medical"></i>'; cssClass = 'asset-bm'; }
  const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="asset-marker ${cssClass}" style="width:30px;height:30px">${iconHtml}</div>`, iconSize: [30, 30] });
  const m = L.marker(center, { icon: icon, draggable: true }).addTo(assetsLayer);
  const assetId = L.stamp(m); 
  const div = document.createElement('div');
  div.innerHTML = `<b>${prefixo}</b><br><small>${type}</small><br><button onclick="removeSpecificAsset(${assetId})" style="background:#ef4444;color:white;border:none;width:100%;margin-top:5px;cursor:pointer;border-radius:4px;padding:4px">REMOVER</button>`;
  m.bindPopup(div);
}
window.removeSpecificAsset = (id) => { assetsLayer.eachLayer(layer => { if (L.stamp(layer) === id) { assetsLayer.removeLayer(layer); } }); };
function sqlToObj(r){ return r.values.map(v => { const o={}; r.columns.forEach((c,i)=>o[c]=v[i]); return o; }); }

// IMPORTA√á√ÉO KML
async function processarKML(inp) {
    if (!inp.files || !inp.files[0]) return;
    showToast("üó∫Ô∏è Lendo KML...", "info");
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const parser = new DOMParser();
            const xml = parser.parseFromString(e.target.result, "text/xml");
            const placemarks = xml.getElementsByTagName("Placemark");
            const novasCameras = [];
            for (let i = 0; i < placemarks.length; i++) {
                const p = placemarks[i];
                const nome = p.getElementsByTagName("name")[0]?.textContent || `CAM-${i}`;
                const coordText = p.getElementsByTagName("coordinates")[0]?.textContent;
                if (!coordText) continue;
                const coords = coordText.trim().split(",");
                const lng = parseFloat(coords[0]); const lat = parseFloat(coords[1]);
                let area = "GERAL";
                const simpleData = p.getElementsByTagName("SimpleData");
                for (let sd of simpleData) { if (sd.getAttribute("name") === "layer") { area = sd.textContent; break; } }
                if (!isNaN(lat) && !isNaN(lng)) { novasCameras.push({ nome, lat, lng, area }); }
            }
            if (novasCameras.length > 0) {
                CAMERAS = novasCameras;
                localStorage.setItem('sicop_cams_v26', JSON.stringify(CAMERAS));
                showToast(`‚úÖ ${novasCameras.length} C√¢meras carregadas!`, "success");
                atualizarSelectAreas(); renderMap(); map.flyTo([novasCameras[0].lat, novasCameras[0].lng], 14);
            } else { showToast("‚ö†Ô∏è Nenhuma c√¢mera v√°lida no KML", "warning"); }
        } catch (err) { console.error(err); showToast("‚ùå Erro KML", "error"); }
    };
    reader.readAsText(inp.files[0]);
    inp.value = '';
}

function abrirModalUsers() { document.getElementById('modalUsers').style.display='flex'; renderUsers(); }
function fecharModalUsers() { document.getElementById('modalUsers').style.display='none'; }
function renderUsers() {
    const tbody = document.getElementById('userListBody'); tbody.innerHTML = '';
    const res = db.exec("SELECT id, user, role FROM usuarios");
    if(res.length) { res[0].values.forEach(row => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${row[0]}</td><td>${row[1]}</td><td><span style="color:${row[2]==='admin'?'var(--accent)':'#ccc'}">${row[2]}</span></td><td><button onclick="delUser(${row[0]})" style="color:red;background:transparent;border:none;cursor:pointer"><i class="fa-solid fa-trash"></i></button></td>`; tbody.appendChild(tr); }); }
}
function criarUsuario() {
    const u = document.getElementById('new_user').value; const p = document.getElementById('new_pass').value; const r = document.getElementById('new_role').value;
    if(!u || !p) return alert("Preencha tudo");
    try { db.run("INSERT INTO usuarios (user, pass, role) VALUES (?, ?, ?)", [u, p, r]); persistir(); renderUsers(); document.getElementById('new_user').value = ''; document.getElementById('new_pass').value = ''; } catch(e) { alert("Erro (usu√°rio j√° existe?)"); }
}
function delUser(id) { if(id===1) return alert("N√£o pode deletar Admin"); if(confirm("Excluir usu√°rio?")) { db.run("DELETE FROM usuarios WHERE id = ?", [id]); persistir(); renderUsers(); } }
function limparAntigas() {
    if(!confirm("Apagar encerradas h√° mais de 7 dias?")) return;
    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 7);
    db.run("DELETE FROM ocorrencias WHERE status = 'ENCERRADA' AND inicio < ?", [cutoff.toISOString()]);
    persistir(); atualizarTudo(); alert("Limpeza conclu√≠da!");
}
</script>
</body>
</html>